@{
    ViewData["Title"] = "Ana Sayfa";
}

@if (User.Identity.IsAuthenticated)
{
    <div class="container mt-4">

        <div class="p-4 mb-4 bg-light rounded-3 shadow-sm text-center border">
            <h1 class="display-5 fw-bold text-primary">Hoş Geldin, @User.Identity.Name!</h1>
            <p class="lead">Spor hedeflerine ulaşmak için bugün harika bir gün.</p>

            <div class="d-flex justify-content-center gap-3 mt-3">
                <a class="btn btn-primary btn-lg rounded-pill px-4" asp-controller="Appointments" asp-action="Create">
                    <i class="bi bi-calendar-check"></i> Randevu Al
                </a>
                <a class="btn btn-outline-dark btn-lg rounded-pill px-4" asp-controller="Gyms" asp-action="Index">
                    <i class="bi bi-building"></i> Salonları Gez
                </a>
            </div>
        </div>

        <div class="card shadow-lg border-0 overflow-hidden">
            <div class="row g-0">
                <div class="col-md-4 bg-dark text-white d-flex flex-column justify-content-center align-items-center p-4 text-center">
                    <div class="mb-3">
                        <i class="bi bi-robot display-1 text-warning"></i>
                    </div>
                    <h3 class="fw-bold">AI Antrenör</h3>
                    <p class="small text-white-50">Google Gemini altyapısı ile sana özel program hazır.</p>
                </div>

                <div class="col-md-8 p-4 position-relative">
                    <h4 class="fw-bold text-dark mb-3">Hemen Programını Oluştur</h4>

                    <form id="aiForm">
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="age" placeholder="Yaş" required min="10" max="100">
                                    <label for="age">Yaş</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="height" placeholder="Boy" required min="100" max="250">
                                    <label for="height">Boy (cm)</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="weight" placeholder="Kilo" required min="30" max="300">
                                    <label for="weight">Kilo (kg)</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-floating mb-3">
                            <select class="form-select" id="goal" required>
                                <option value="Kilo Vermek">Kilo Vermek & Yağ Yakmak</option>
                                <option value="Kas Yapmak">Kas Kütlesini Artırmak</option>
                                <option value="Form Korumak">Formumu Korumak / Zinde Kalmak</option>
                            </select>
                            <label for="goal">Hedefin Ne?</label>
                        </div>
                        <div class="mb-3">
                            <label for="userPhoto" class="form-label fw-bold text-muted small">Vücut Fotoğrafın </label>
                            <input class="form-control form-control-sm" type="file" id="userPhoto" accept="image/*">
                            <div class="form-text x-small">Daha doğru analiz için boydan bir fotoğraf yükleyebilirsin.</div>
                        </div>

                        <button type="submit" class="btn btn-warning fw-bold w-100 py-2 rounded-3">
                            <i class="bi bi-stars"></i> Yapay Zekaya Sor
                        </button>
                    </form>

                    <div id="aiResultArea" class="d-none mt-3 p-3 bg-light rounded border">
                        <h6 class="fw-bold text-primary border-bottom pb-2">📋 Senin İçin Önerim:</h6>
                        <div id="aiResponseText" class="small text-dark" style="max-height: 300px; overflow-y: auto;"></div>
                        <button class="btn btn-sm btn-outline-secondary w-100 mt-2" onclick="resetAiForm()">Yeni Hesaplama</button>
                    </div>

                    <div id="aiLoading" class="position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-90 d-none flex-column justify-content-center align-items-center" style="z-index: 5;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 fw-bold text-primary">Yapay zeka düşünüyor...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="container-fluid p-0" style="height: 85vh; overflow: hidden;">
        <div class="row h-100 g-0">

            <div class="col-lg-7 d-none d-lg-flex flex-column justify-content-center align-items-center text-white text-center p-5"
                 style="background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1534438327276-14e5300c3a48?q=80&w=1470&auto=format&fit=crop'); background-size: cover; background-position: center;">
                <h1 class="display-3 fw-bold mb-3">Sınırlarını Zorla.</h1>
                <p class="lead fs-3 mb-4">En iyi eğitmenler ve son teknoloji ekipmanlarla<br>hedeflerine ulaşmaya hazır mısın?</p>
                <a asp-controller="Gyms" asp-action="Index" class="btn btn-outline-light btn-lg rounded-pill px-5">Salonlarımızı Keşfet</a>
            </div>

            <div class="col-lg-5 d-flex align-items-center justify-content-center bg-white">
                <div class="w-75 p-4">
                    <div class="text-center mb-4">
                        <h2 class="fw-bold text-primary">Giriş Yap</h2>
                        <p class="text-muted">Hesabınıza erişmek için bilgilerinizi girin.</p>
                    </div>

                    <form action="/Identity/Account/Login" method="post">
                        @Html.AntiForgeryToken()

                        <div class="form-floating mb-3">
                            <input name="Input.Email" type="email" class="form-control" id="floatingInput" placeholder="name@example.com" required>
                            <label for="floatingInput">E-Posta Adresi</label>
                        </div>

                        <div class="form-floating mb-3">
                            <input name="Input.Password" type="password" class="form-control" id="floatingPassword" placeholder="Şifre" required>
                            <label for="floatingPassword">Şifre</label>
                        </div>

                        <div class="checkbox mb-3">
                            <label>
                                <input name="Input.RememberMe" type="checkbox" value="true" /> Beni Hatırla
                            </label>
                        </div>

                        <button class="w-100 btn btn-lg btn-primary rounded-pill mb-3" type="submit">Giriş Yap</button>

                        <div class="text-center">
                            <p class="text-muted">Hesabın yok mu?</p>
                            <a class="btn btn-outline-secondary w-100 rounded-pill" asp-area="Identity" asp-page="/Account/Register">
                                Kayıt Ol
                            </a>
                        </div>

                        <div class="text-center mt-3">
                            <a class="small text-muted" asp-area="Identity" asp-page="/Account/ForgotPassword">Şifremi Unuttum</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        var aiForm = document.getElementById('aiForm');

        if (aiForm) {
            aiForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // Yükleniyor ekranını aç
                var loadingDiv = document.getElementById('aiLoading');
                loadingDiv.classList.remove('d-none');
                loadingDiv.classList.add('d-flex');
                document.getElementById('aiResultArea').classList.add('d-none');

                // --- ÖNEMLİ: Dosya göndermek için FormData kullanıyoruz ---
                var formData = new FormData();
                formData.append('age', document.getElementById('age').value);
                formData.append('height', document.getElementById('height').value);
                formData.append('weight', document.getElementById('weight').value);
                formData.append('goal', document.getElementById('goal').value);

                // Eğer fotoğraf seçildiyse onu da pakete ekle
                var photoInput = document.getElementById('userPhoto');
                if (photoInput.files.length > 0) {
                    formData.append('userPhoto', photoInput.files[0]);
                }

                $.ajax({
                    url: '/Ai/GetPlan',
                    type: 'POST',
                    data: formData, // JSON değil FormData gönderiyoruz
                    processData: false, // Dosya olduğu için false
                    contentType: false, // Dosya olduğu için false
                    success: function(response) {
                        loadingDiv.classList.add('d-none');
                        loadingDiv.classList.remove('d-flex');

                        if (response.success) {
                            document.getElementById('aiForm').classList.add('d-none');
                            document.getElementById('aiResultArea').classList.remove('d-none');
                            document.getElementById('aiResponseText').innerHTML = response.data;
                        } else {
                            alert("Hata: " + response.message);
                        }
                    },
                    error: function() {
                        loadingDiv.classList.add('d-none');
                        loadingDiv.classList.remove('d-flex');
                        alert("Sunucu ile bağlantı hatası.");
                    }
                });
            });
        }

        function resetAiForm() {
            document.getElementById('aiResultArea').classList.add('d-none');
            document.getElementById('aiForm').classList.remove('d-none');
            document.getElementById('aiForm').reset();
            // Dosya inputunu da temizle
            document.getElementById('userPhoto').value = "";
        }
    </script>
}